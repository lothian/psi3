#define EXTERN
#include <stdio.h>
#include <stdlib.h>
#include <libciomr.h>
#include <math.h>
#include "input.h"
#include "global.h"
#include "defines.h"


/*-----------------------------------------------------------------------------------------------------------------
  This function builds arrays of coefficients and labels for unique SO classes
 -----------------------------------------------------------------------------------------------------------------*/

void build_so_classes()
{
  int i,j,l,tmp;
  int atom, ua;
  int kfirst, klast;
  int class,lmax,irr,ao,symop,char_i;
  int ao_first, ao_last, ao_max, ao_irr;
  int class_first, class_last, uc;
  int shell, shell_first, shell_last;
  int **class_num_angmom;
  int **coeff_irr;
  int so_cnt, so_blk_lim, so_blk_off, cnt;
  int ao_offset;
  int basisfn_num_in_symblk;
  int *first_basisfn_in_symblk_offset;
  int *first_basisfn_in_symblk;


    /*----------------------------------------------------------------
      Compute maximum angular momentum number for each class of atoms
     ----------------------------------------------------------------*/

    max_angmom_class = init_int_array(num_classes);
    class_num_angmom = init_int_matrix(num_classes,max_angmom+1);
    for(i=0;i<num_atoms;i++) {
      kfirst = first_shell_on_atom[i];
      klast = kfirst + nshells_per_atom[i];
      class = atom_class[i];
      for(j=kfirst;j<klast;j++) {
	max_angmom_class[class] = (max_angmom_class[class] > shell_ang_mom[j]) ? max_angmom_class[class] : shell_ang_mom[j];
	class_num_angmom[class][shell_ang_mom[j]]++;
      }
    }
/*    for(ua=0;ua<num_uniques;ua++) {
      atom = u2a[ua];
      kfirst = first_shell_on_atom[atom];
      klast = kfirst + nshells_per_atom[atom];
      class = atom_class[atom];
      for(j=kfirst;j<klast;j++) {
        max_angmom_class[class] = (max_angmom_class[class] > shell_ang_mom[j]) ? max_angmom_class[class] : shell_ang_mom[j];
        class_num_angmom[class][shell_ang_mom[j]]++;
      }
    }*/

    
    /*-----------------------
      Allocate global arrays
     -----------------------*/

    num_angso_coeff = 0;
    num_cart_so_in_class = (int ***) malloc(num_classes*sizeof(int **));
    for(class=0;class<num_classes;class++)
      num_cart_so_in_class[class] = init_int_matrix(max_angmom_class[class]+1,nirreps);
    class_so_coeff = (double ****) malloc(num_classes*sizeof(double ***));
    for(i=0;i<num_classes;i++)
      class_so_coeff[i] = (double ***) malloc((max_angmom_class[i]+1)*sizeof(double **));
    if (puream) {
      num_pureang_so_in_class = (int ***) malloc(num_classes*sizeof(int **));
      for(class=0;class<num_classes;class++)
	num_pureang_so_in_class[class] = init_int_matrix(max_angmom_class[class]+1,nirreps);
    }
    first_angso_coeff_class = (int **) malloc(num_classes*sizeof(int *));
    last_angso_coeff_class = (int **) malloc(num_classes*sizeof(int *));
    for(class=0;class<num_classes;class++) {
      first_angso_coeff_class[class] = init_int_array(max_angmom_class[class]+1);
      last_angso_coeff_class[class] = init_int_array(max_angmom_class[class]+1);
    }
    

    /*----------------------
      Allocate local arrays
     -----------------------*/

    coeff_irr = init_int_matrix(nirreps,ioff[max_angmom+1]);

    
    /*------------------------------------------------------------------------------------------------------------------------
      Loop over each unique class, each angular momentum number within class, irreps, and basis function types
      and 1) count number of SO in each representation num_cart_so_in_class[class][l][irr] generated by a shell of ang momentum l
      on an atom of a unique class "uc" or its symmetry equivalent classes;
      2) form matrices of coefficients and labels for classes equivalent to the unique class "uc"
     ------------------------------------------------------------------------------------------------------------------------*/
    for(uc=0;uc<num_unique_classes;uc++) {
      class = uc2c[uc];
      class_first = class;
      class_last = class + unique_class_degen[uc];
      lmax = max_angmom_class[class];
      for(l=0;l<=lmax;l++) {
	ao_max = ioff[l+1];
/*	for(i=class_first;i<class_last;i++)
	  class_so_coeff[i][l] = init_matrix(nirreps,ao_max);*/
        for(symop=0;symop<nirreps;symop++)
	  if (class_orbit[class][symop] == class)
	    for(irr=0;irr<nirreps;irr++)
	      for(ao=0;ao<ao_max;ao++)
		coeff_irr[irr][ao] += irr_char[irr][symop]*ao_type_transmat[l][symop][ao];
	for(irr=0;irr<nirreps;irr++)
	  for(ao=0;ao<ao_max;ao++)
	    if (coeff_irr[irr][ao] > 0)
	      for(i=class_first;i<class_last;i++)
		num_cart_so_in_class[i][l][irr] += 1;

	if (puream) {
	  for(irr=0;irr<nirreps;irr++)
	    for(i=class_first;i<class_last;i++)
	      num_pureang_so_in_class[i][l][irr] = num_cart_so_in_class[i][l][irr];
	  for(ao_irr=0;ao_irr<nirreps;ao_irr++)
	    if (num_cart_so[l][ao_irr] != 0)
	      for(ao=0;ao<ao_max;ao++)
		if (ao_type_irr[l][ao] == ao_irr) {
		  for(irr=0;irr<nirreps;irr++)
		    if (coeff_irr[irr][ao] > 0)
		      for(i=class_first;i<class_last;i++)
			num_pureang_so_in_class[i][l][irr] -= num_redun_so[l][ao_irr];
		  break;
		}
	}

	/*---------------------------------
	  Remove after testing is complete
	 ---------------------------------*/
	if (print_lvl >= DEBUGPRINT) {
	  fprintf(outfile,"    Class = %d  l = %d\n     Number of cartesian SOs in symmetry blocks:",class+1,l);
	  for(irr=0;irr<nirreps;irr++)
	    fprintf(outfile," %d",num_cart_so_in_class[class][l][irr]);
	  fprintf(outfile,"\n\n");
	  if (puream) {
	    fprintf(outfile,"    Class = %d  l = %d\n     Number of pure angular momentum SOs in symmetry blocks:",class+1,l);
	    for(irr=0;irr<nirreps;irr++)
	      fprintf(outfile," %d",num_pureang_so_in_class[class][l][irr]);
	    fprintf(outfile,"\n\n");
	  }
	}

	/*Compute SO coefficients and labels for ALL classes - childs of a unique class "class"*/
	for(i=class_first;i<class_last;i++) {
	  class_so_coeff[i][l] = init_matrix(ao_max*unique_class_degen[uc],ao_max);
	  for(irr=0;irr<nirreps;irr++)
	    bzero((char *)coeff_irr[irr],sizeof(int)*ao_max);
	  for(symop=0;symop<nirreps;symop++)
	    if (class_orbit[class_first][symop] == i)
	      for(irr=0;irr<nirreps;irr++)
		if (num_cart_so_in_class[class][l][irr] != 0) /*There are SOs in this class and ang. momentum type*/
		  for(ao=0;ao<ao_max;ao++)
		    coeff_irr[irr][ao] += irr_char[irr][symop]*ao_type_transmat[l][symop][ao];
	  so_cnt = 0;
	  for(irr=0;irr<nirreps;irr++)
	    if (num_cart_so_in_class[class][l][irr] != 0)
	      for(ao=0;ao<ao_max;ao++)
		if (coeff_irr[irr][ao] != 0)
		  class_so_coeff[i][l][so_cnt++][ao] = sign(coeff_irr[irr][ao]);
	}
	for(irr=0;irr<nirreps;irr++)
	  bzero((char *)coeff_irr[irr],sizeof(int)*ao_max);
      }
    }

    /*---------------------------------
      Remove after testing is complete
     ---------------------------------*/
    if (print_lvl >= DEBUGPRINT)
      for(uc=0;uc<num_unique_classes;uc++) {
	class = uc2c[uc];
	class_first = class;
	class_last = class + unique_class_degen[uc];
	lmax = max_angmom_class[class];
	for(i=class_first;i<class_last;i++) {
	  fprintf(outfile,"\n    Class = %d\n",i+1);
	  for(l=0;l<=lmax;l++) {
	    ao_max = ioff[l+1];
	    fprintf(outfile,"     l = %d\n",l);
	    for(j=0;j<ao_max*unique_class_degen[uc];j++) {
	      fprintf(outfile,"     ");
	      for(ao=0;ao<ao_max;ao++)
		fprintf(outfile,"    %4.1lf",class_so_coeff[i][l][j][ao]);
	      fprintf(outfile,"\n");
	    }
	  }
	}
      }


    /*------------------------
      Compute num_angso_coeff
     ------------------------*/

    for(uc=0;uc<num_unique_classes;uc++){
      class = uc2c[uc];
      class_first = class;
      class_last = class + unique_class_degen[uc];
      lmax = max_angmom_class[class];
      for(i=class_first;i<class_last;i++)
	for(l=0;l<=lmax;l++) {
	  ao_max = ioff[l+1];
	  num_angso_coeff += ao_max*unique_class_degen[uc]*ao_max;
	}
    }

    
    /*------------------------------------------------------
      Compute angso_coeff and angso_labels needed in file30
     ------------------------------------------------------*/
    
    angso_coeff = init_array(num_angso_coeff);
    angso_labels = init_int_matrix(num_angso_coeff,4);
    first_basisfn_in_symblk = init_int_array(nirreps);
    first_basisfn_in_symblk_offset = init_int_array(nirreps);
    cnt = 0;
    for(uc=0;uc<num_unique_classes;uc++) {
      class = uc2c[uc];
      class_first = class;
      class_last = class + unique_class_degen[uc];
      lmax = max_angmom_class[class];
      for(i=class_first;i<class_last;i++) {
	ao_offset = 0;
	for(irr=0;irr<nirreps;irr++)
	  first_basisfn_in_symblk[irr] = first_basisfn_in_symblk_offset[irr];
	for(l=0;l<=lmax;l++) {
	  ao_max = ioff[l+1];
	  first_angso_coeff_class[i][l] = cnt;
	  so_blk_lim = ao_max*unique_class_degen[uc];
	  for(j=0;j<so_blk_lim;j++) {
	    so_blk_off = j*ao_max;
	    for(ao=0;ao<ao_max;ao++)
	      angso_coeff[cnt+so_blk_off+ao] = class_so_coeff[i][l][j][ao];
	  }
	  for(irr=0;irr<nirreps;irr++)
	    if (num_cart_so_in_class[class][l][irr] != 0) {
	      for(so_cnt=0;so_cnt<num_cart_so_in_class[class][l][irr];so_cnt++) {
		basisfn_num_in_symblk = first_basisfn_in_symblk[irr] + so_cnt;
		for(ao=0;ao<ao_max;ao++) {
		  angso_labels[cnt][0] = ao_offset + ao + 1;
		  angso_labels[cnt][1] = basisfn_num_in_symblk + 1; 
		  angso_labels[cnt][2] = irr + 1;
		  angso_labels[cnt++][3] = 1;
		}
	      }
	      first_basisfn_in_symblk[irr] += class_num_angmom[i][l] * so_cnt;
	    }
	  ao_offset += ao_max;
	  last_angso_coeff_class[i][l] = cnt;
	}
      }
      for(irr=0;irr<nirreps;irr++)
	first_basisfn_in_symblk_offset[irr] = first_basisfn_in_symblk[irr];
    }

    
    /*---------------------------------
      Remove after testing is complete
     ---------------------------------*/
    if (print_lvl >= DEBUGPRINT) {
      fprintf(outfile,"\n\n    ANGSO_COEFF :\n");
      for(i=0;i<num_angso_coeff;i++)
	fprintf(outfile,"    i=%4d\t%8.3lf\n",i+1,angso_coeff[i]);
      fprintf(outfile,"\n");
      fprintf(outfile,"\n    ANGSO_LABELS :\n\n");
      for(i=0;i<num_angso_coeff;i++) {
	fprintf(outfile,"    i=%4d\t",i+1);
	for(j=0;j<4;j++)
	  fprintf(outfile,"%4d ",angso_labels[i][j]);
	fprintf(outfile,"\n");
      }
      fprintf(outfile,"\n\n");
    }

    return;
}



